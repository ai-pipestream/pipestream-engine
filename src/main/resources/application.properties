# Engine Service Configuration
quarkus.application.name=pipestream-engine
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# Module Call Retry Configuration
# ======================================================================================================================
# Maximum number of retry attempts for transient gRPC failures (UNAVAILABLE, DEADLINE_EXCEEDED, RESOURCE_EXHAUSTED)
pipestream.module.retry.max-attempts=3
# Initial delay for exponential backoff (milliseconds)
pipestream.module.retry.initial-delay-ms=100
# Maximum delay cap for exponential backoff (milliseconds)
pipestream.module.retry.max-delay-ms=2000

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Engine service port (38103)
quarkus.http.host=0.0.0.0
quarkus.http.port=38103

# HTTP body size limit - 2GB to match gRPC limits for large documents
quarkus.http.limits.max-body-size=2G
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# Enable virtual threads for gRPC (JDK 21+) - allows blocking code without stalling IO thread
quarkus.grpc.server.use-virtual-threads=true

# gRPC Flow Control - 50MB window for large messages
quarkus.grpc.server.flow-control-window=52428800

# Set gRPC client flow control for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=52428800

# Dev configuration
%dev.quarkus.http.port=38103
%dev.quarkus.http.root-path=/engine

# Test configuration
%test.quarkus.http.test-port=0

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
%test.pipestream.registration.enabled=false
pipestream.registration.service-name=engine
pipestream.registration.description=Central orchestration service that routes documents through processing pipelines
pipestream.registration.type=SERVICE
pipestream.registration.advertised-host=${SERVICE_REGISTRATION_ADVERTISED_HOST:host.docker.internal}
pipestream.registration.advertised-port=${quarkus.http.port}
pipestream.registration.internal-host=${SERVICE_REGISTRATION_INTERNAL_HOST:172.17.0.1}
pipestream.registration.internal-port=${quarkus.http.port}
pipestream.registration.capabilities=document-processing,pipeline-orchestration,graph-routing
pipestream.registration.tags=engine,orchestration,core-service,traefik.enable=true,traefik.http.routers.engine.rule=PathPrefix(`/engine`),traefik.http.routers.engine.entrypoints=web,traefik.http.middlewares.engine-slash.redirectregex.regex=^/engine$$,traefik.http.middlewares.engine-slash.redirectregex.replacement=/engine/,traefik.http.routers.engine.middlewares=engine-slash

# Registration service connection (platform-registration-service)
pipestream.registration.registration-service.host=localhost
pipestream.registration.registration-service.port=38101

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# General Dev Services
%dev.quarkus.devservices.enabled=true

# Docker Compose Dev Services (Dev Profile) - Use shared dev services via extension
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true
%dev.quarkus.devservices.timeout=120s

# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true

# Dynamic gRPC Service Discovery
quarkus.consul.host=${CONSUL_HOST:localhost}
quarkus.consul.port=${CONSUL_PORT:8500}

# ======================================================================================================================
# Kafka Configuration (Producer only - engine publishes, sidecar consumes)
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}

# Apicurio Registry configuration (DevServices auto-sets this in dev/test)
%prod.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v3}

## NOTE
## ----- Engine Routing (Outgoing - Dynamic Topics) -----
## The Apicurio extension auto-configures Protobuf serialization and UUID key serialization
## Topic is set dynamically per message via OutgoingKafkaRecordMetadata
#mp.messaging.outgoing.engine-routing-out.connector=smallrye-kafka
#mp.messaging.outgoing.engine-routing-out.topic=engine-routing-default


# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=postgresql

# Dev mode - use shared compose PostgreSQL (pipeline/password from compose-devservices.yml)
%dev.quarkus.datasource.username=pipeline
%dev.quarkus.datasource.password=password
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/pipeline
%dev.quarkus.datasource.reactive.url=postgresql://localhost:5432/pipeline

# Test mode - use DevServices with default credentials
%test.quarkus.datasource.username=quarkus_test
%test.quarkus.datasource.password=quarkus_test

# Hibernate Reactive configuration
# Note: Hibernate Reactive doesn't support automatic schema generation, use Flyway instead
quarkus.hibernate-reactive.datasource=default

# Dev: Use Flyway migrations (clean-at-start resets schema on each restart)
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.clean-at-start=true
%dev.quarkus.flyway.baseline-on-migrate=true

# Test: Use Flyway to create schema (DevServices provides URLs automatically)
%test.quarkus.flyway.migrate-at-start=true
%test.quarkus.flyway.clean-at-start=true
%test.quarkus.flyway.baseline-on-migrate=true

# Prod: Use Flyway migrations
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

# Dev Services Configuration
# Dev: Disable standalone datasource devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=false

# Test: Use Quarkus DevServices for PostgreSQL (provides both JDBC and reactive URLs automatically)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.enabled=false
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.datasource.devservices.image-name=postgres:16

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
quarkus.log.level=INFO
quarkus.log.category."ai.pipestream.engine".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN

# Health checks
quarkus.smallrye-health.root-path=/q/health
quarkus.smallrye-health.liveness-path=/q/health/live
quarkus.smallrye-health.readiness-path=/q/health/ready

# ======================================================================================================================
# Micrometer/Prometheus Metrics Configuration
# ======================================================================================================================
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# ======================================================================================================================
# OpenTelemetry Tracing Configuration
# ======================================================================================================================
quarkus.otel.enabled=true
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
%dev.quarkus.otel.enabled=false
%test.quarkus.otel.enabled=false

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=pipestream-engine
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# Jandex indexing for third-party and internal dynamic gRPC libraries
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka
quarkus.index-dependency.grpc-stubs.group-id=io.pipeline
quarkus.index-dependency.grpc-stubs.artifact-id=grpc-stubs
quarkus.index-dependency.dynamic-grpc.group-id=io.pipeline
quarkus.index-dependency.dynamic-grpc.artifact-id=dynamic-grpc
quarkus.index-dependency.pipestream-registration.group-id=ai.pipestream
quarkus.index-dependency.pipestream-registration.artifact-id=pipestream-service-registration
quarkus.index-dependency.pipestream-dynamic-grpc.group-id=ai.pipestream
quarkus.index-dependency.pipestream-dynamic-grpc.artifact-id=quarkus-dynamic-grpc

